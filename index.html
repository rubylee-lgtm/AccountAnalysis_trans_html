<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>財務 AccountAnalysis 轉換工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        // 備用彩帶效果，如果CDN載入失敗
        window.fallbackConfetti = function() {
            console.log('🎉 轉換完成！');
            // 簡單的視覺反饋
            document.body.style.background = 'linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1)';
            setTimeout(() => {
                document.body.style.background = '';
            }, 1000);
        };
    </script>
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-2xl">
        <!-- 標題 -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">財務 AccountAnalysis 轉換工具</h1>
            <p class="text-gray-600">上傳CSV檔案，轉換為標準格式</p>
        </div>

        <!-- 檔案選擇區域 -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                選擇檔案
            </label>
            <div class="flex items-center space-x-4">
                <input
                    id="fileInput"
                    type="file"
                    accept=".csv"
                    class="hidden"
                />
                <button
                    id="fileButton"
                    class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                >
                    選擇檔案
                </button>
                <div id="fileInfo" class="flex items-center space-x-2" style="display: none;">
                    <span class="text-sm text-gray-600" id="fileName"></span>
                    <button
                        id="clearButton"
                        class="px-3 py-1 text-xs bg-gray-200 text-gray-600 rounded hover:bg-gray-300 transition-colors"
                    >
                        清除
                    </button>
                </div>
            </div>
        </div>

        <!-- 轉換按鈕 -->
        <div class="mb-6">
            <button
                id="convertButton"
                disabled
                class="w-full py-3 px-6 rounded-lg font-medium transition-colors bg-gray-300 text-gray-500 cursor-not-allowed"
            >
                轉換
            </button>
        </div>

        <!-- 載入狀態 -->
        <div id="loadingSection" class="text-center mb-6" style="display: none;">
            <div class="inline-block w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full spinner"></div>
            <p class="mt-2 text-gray-600">轉換中...</p>
        </div>

        <!-- 下載按鈕 -->
        <div id="downloadSection" class="text-center" style="display: none;">
            <button
                id="downloadButton"
                class="px-8 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-medium"
            >
                下載檔案
            </button>
            <p id="statusText" class="text-sm text-gray-500 mt-2"></p>
        </div>

        <!-- Excel檔案提示 -->
        <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-yellow-800">Excel檔案處理說明</h3>
                    <div class="mt-2 text-sm text-yellow-700">
                        <p>目前版本僅支援CSV檔案轉換。如果您有Excel檔案，請按照以下步驟處理：</p>
                        <ol class="mt-2 list-decimal list-inside space-y-1">
                            <li>開啟Excel檔案</li>
                            <li>點擊「檔案」→「另存新檔」</li>
                            <li>選擇「CSV (逗號分隔)」格式</li>
                            <li>儲存後再上傳到此工具</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        <!-- 目標欄位說明 -->
        <div class="mt-8 p-4 bg-gray-50 rounded-lg">
            <h3 class="font-medium text-gray-800 mb-2">目標欄位順序：</h3>
            <div class="text-sm text-gray-600 grid grid-cols-2 gap-1">
                <div class="flex items-center">
                    <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-medium mr-2">1</span>
                    PARTY_NUMBER
                </div>
                <div class="flex items-center">
                    <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-medium mr-2">2</span>
                    PARTY_NAME
                </div>
                <div class="flex items-center">
                    <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-medium mr-2">3</span>
                    PERIOD_NAME
                </div>
                <div class="flex items-center">
                    <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-medium mr-2">4</span>
                    NATURAL_ACCOUNT_SEGMENT
                </div>
                <div class="flex items-center">
                    <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-medium mr-2">5</span>
                    NATURAL_ACCOUNT_DESC
                </div>
                <div class="flex items-center">
                    <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-medium mr-2">6</span>
                    GL_DATE
                </div>
                <div class="flex items-center">
                    <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-medium mr-2">7</span>
                    TRANSACTION_NUMBER
                </div>
                <div class="flex items-center">
                    <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-medium mr-2">8</span>
                    LINE_DESCRIPTION
                </div>
                <div class="flex items-center">
                    <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-medium mr-2">9</span>
                    ACCOUNTED_DR
                </div>
                <div class="flex items-center">
                    <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-medium mr-2">10</span>
                    ACCOUNTED_CR
                </div>
            </div>
        </div>
    </div>

    <script>
        // 定義需要的欄位順序
        const REQUIRED_COLUMNS = [
            'PARTY_NUMBER',
            'PARTY_NAME', 
            'PERIOD_NAME',
            'NATURAL_ACCOUNT_SEGMENT',
            'NATURAL_ACCOUNT_DESC',
            'GL_DATE',
            'TRANSACTION_NUMBER',
            'LINE_DESCRIPTION',
            'ACCOUNTED_DR',
            'ACCOUNTED_CR'
        ];

        // DOM 元素
        const fileInput = document.getElementById('fileInput');
        const fileButton = document.getElementById('fileButton');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const clearButton = document.getElementById('clearButton');
        const convertButton = document.getElementById('convertButton');
        const loadingSection = document.getElementById('loadingSection');
        const downloadSection = document.getElementById('downloadSection');
        const downloadButton = document.getElementById('downloadButton');
        const statusText = document.getElementById('statusText');

        // 狀態變數
        let selectedFile = null;
        let convertedData = null;

        // 觸發彩帶效果
        function triggerConfetti() {
            // 檢查 confetti 是否已載入
            if (typeof confetti !== 'undefined') {
                try {
                    confetti({
                        particleCount: 100,
                        spread: 70,
                        origin: { y: 0.6 },
                        colors: ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3']
                    });
                } catch (error) {
                    console.log('彩帶效果執行失敗，使用備用方案');
                    window.fallbackConfetti();
                }
            } else {
                console.log('彩帶效果載入中，使用備用方案');
                // 如果 confetti 還沒載入，使用備用方案
                window.fallbackConfetti();
            }
        }

        // 檔案選擇處理
        fileButton.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                selectedFile = file;
                fileName.textContent = `已選擇：${file.name}`;
                fileInfo.style.display = 'flex';
                fileButton.textContent = '重新選擇檔案';
                convertButton.disabled = false;
                convertButton.className = 'w-full py-3 px-6 rounded-lg font-medium transition-colors bg-green-600 text-white hover:bg-green-700';
                downloadSection.style.display = 'none';
            }
        });

        // 清除檔案
        clearButton.addEventListener('click', () => {
            selectedFile = null;
            fileInput.value = '';
            fileInfo.style.display = 'none';
            fileButton.textContent = '選擇檔案';
            convertButton.disabled = true;
            convertButton.className = 'w-full py-3 px-6 rounded-lg font-medium transition-colors bg-gray-300 text-gray-500 cursor-not-allowed';
            downloadSection.style.display = 'none';
        });

        // 轉換檔案
        convertButton.addEventListener('click', async () => {
            if (!selectedFile) return;

            // 顯示載入狀態
            convertButton.disabled = true;
            convertButton.className = 'w-full py-3 px-6 rounded-lg font-medium transition-colors bg-gray-300 text-gray-500 cursor-not-allowed';
            loadingSection.style.display = 'block';
            downloadSection.style.display = 'none';

            try {
                console.log('開始處理檔案:', selectedFile.name);
                
                // 檢查檔案類型
                const fileExtension = selectedFile.name.split('.').pop().toLowerCase();
                console.log('檔案類型:', fileExtension);
                
                // 如果是Excel檔案，顯示警語
                if (['xlsx', 'xls'].includes(fileExtension)) {
                    throw new Error('目前不支援Excel轉檔，請先將Excel檔案另存為CSV格式後再上傳');
                }
                
                // 只處理CSV檔案
                if (fileExtension !== 'csv') {
                    throw new Error('請上傳CSV檔案');
                }
                
                console.log('處理CSV檔案...');
                const text = await selectedFile.text();
                console.log('檔案大小:', text.length, '字元');
                
                // 使用PapaParse解析CSV
                const result = Papa.parse(text, { 
                    header: true, 
                    skipEmptyLines: true,
                    dynamicTyping: false  // 不要自動轉型
                });
                
                const data = result.data;
                console.log('CSV解析完成，資料筆數:', data.length);
                
                // 轉換資料格式 - 完整保留原始字串內容
                convertedData = data.map(row => {
                    const newRow = {};
                    REQUIRED_COLUMNS.forEach(column => {
                        const value = row[column];
                        // 所有欄位都強制保持原始字串格式，不做任何轉換
                        if (value !== undefined && value !== null) {
                            // 直接轉換為字串，保持原始格式
                            let stringValue = String(value);
                            
                            // 特別處理 PERIOD_NAME 和 GL_DATE，確保完全保持原始格式
                            if (column === 'PERIOD_NAME' || column === 'GL_DATE') {
                                // 對於日期相關欄位，確保完全保持原始格式
                                newRow[column] = stringValue.trim();
                            } else {
                                // 其他欄位也保持原始字串格式
                                newRow[column] = stringValue.trim();
                            }
                        } else {
                            newRow[column] = '';
                        }
                    });
                    return newRow;
                });

                console.log('轉換完成，資料筆數:', convertedData.length);
                
                // 檢查轉換結果
                if (!convertedData || convertedData.length === 0) {
                    throw new Error('轉換後沒有資料，請檢查檔案格式是否正確');
                }

                // 隱藏載入狀態，顯示下載按鈕
                loadingSection.style.display = 'none';
                downloadSection.style.display = 'block';
                statusText.textContent = `已轉換 ${convertedData.length} 筆資料`;
                
                // 觸發彩帶效果
                triggerConfetti();
                
                // 恢復轉換按鈕
                convertButton.disabled = false;
                convertButton.className = 'w-full py-3 px-6 rounded-lg font-medium transition-colors bg-green-600 text-white hover:bg-green-700';

            } catch (error) {
                console.error('轉換失敗:', error);
                loadingSection.style.display = 'none';
                convertButton.disabled = false;
                convertButton.className = 'w-full py-3 px-6 rounded-lg font-medium transition-colors bg-green-600 text-white hover:bg-green-700';
                alert('檔案處理失敗：' + error.message);
            }
        });

        // 下載檔案
        downloadButton.addEventListener('click', () => {
            if (!convertedData) return;

            console.log('開始生成下載檔案...');
            
            // 手動生成CSV內容，使用更強力的格式保護
            let csv = '';
            
            // 添加標題行 - 確保所有標題都被雙引號包住
            const headers = REQUIRED_COLUMNS.map(col => `"${col}"`).join(',');
            csv += headers + '\n';
            
            // 添加資料行 - 使用更強力的格式保護
            convertedData.forEach(row => {
                const values = REQUIRED_COLUMNS.map(column => {
                    const value = row[column] || '';
                    // 強制轉換為字串，確保不會被轉換為數字或日期
                    let stringValue = String(value);
                    
                    // 特別處理可能被Excel自動轉換的欄位
                    if (column === 'PERIOD_NAME' || column === 'GL_DATE') {
                        // 對於日期相關欄位，確保完全保持原始格式
                        stringValue = stringValue.trim();
                        
                        // 如果值看起來像日期，保持原始格式
                        if (stringValue.match(/^\d{4}\/\d{1,2}\/\d{1,2}$/) || 
                            stringValue.match(/^\d{1,2}-[A-Za-z]{3}$/) ||
                            stringValue.match(/^[A-Za-z]{3}-\d{2}$/)) {
                            // 保持原始格式，不做任何修改
                        }
                    }
                    
                    // 處理內部引號和特殊字符，確保CSV格式正確
                    let escapedValue = stringValue
                        .replace(/"/g, '""')  // 轉義雙引號
                        .replace(/\n/g, ' ')  // 替換換行符
                        .replace(/\r/g, ' ')  // 替換回車符
                        .replace(/\t/g, ' ')  // 替換製表符
                    
                    // 確保所有值都被雙引號包住，防止Excel自動轉換
                    return `"${escapedValue}"`;
                });
                csv += values.join(',') + '\n';
            });
            
            // 生成檔案名稱
            const filename = 'converted.csv';
            
            // 添加BOM (Byte Order Mark) 來確保UTF-8編碼正確顯示
            const BOM = '\uFEFF';
            const csvWithBOM = BOM + csv;
            
            // 使用更明確的MIME類型，防止Excel自動轉換
            const blob = new Blob([csvWithBOM], { 
                type: 'text/csv;charset=utf-8;' 
            });
            
            // 創建下載連結，使用更強力的格式保護
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            // 添加額外的屬性來防止Excel自動轉換
            link.setAttribute('data-format', 'csv');
            link.setAttribute('data-encoding', 'utf-8');
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            console.log('檔案下載完成:', filename);
        });
    </script>
</body>
</html>
