<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è²¡å‹™ AccountAnalysis è½‰æ›å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-2xl">
        <!-- æ¨™é¡Œ -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">è²¡å‹™ AccountAnalysis è½‰æ›å·¥å…·</h1>
            <p class="text-gray-600">ä¸Šå‚³CSVæª”æ¡ˆï¼Œè½‰æ›ç‚ºæ¨™æº–æ ¼å¼</p>
        </div>

        <!-- æª”æ¡ˆä¸Šå‚³å€åŸŸ -->
        <div class="mb-6">
            <input
                id="fileInput"
                type="file"
                accept=".csv"
                class="hidden"
            />
            <button
                id="fileButton"
                class="w-full py-4 px-6 border-2 border-dashed border-gray-300 rounded-lg hover:border-blue-400 hover:bg-blue-50 transition-colors cursor-pointer"
            >
                <div class="text-center">
                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-4 4H8m4 4v8m-4-4h8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <p class="mt-2 text-sm text-gray-600">é»æ“Šé¸æ“‡CSVæª”æ¡ˆ</p>
                </div>
            </button>
        </div>

        <!-- æª”æ¡ˆè³‡è¨Š -->
        <div id="fileInfo" class="mb-6 hidden">
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                <div class="flex items-center">
                    <svg class="h-5 w-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                    <span id="fileName" class="text-sm font-medium text-gray-700"></span>
                </div>
                <button
                    id="clearButton"
                    class="text-red-500 hover:text-red-700 text-sm font-medium"
                >
                    é‡æ–°é¸æ“‡
                </button>
            </div>
        </div>

        <!-- è½‰æ›æŒ‰éˆ• -->
        <button
            id="convertButton"
            class="w-full py-3 px-6 rounded-lg font-medium transition-colors bg-green-600 text-white hover:bg-green-700 disabled:bg-gray-300 disabled:text-gray-500 disabled:cursor-not-allowed"
            disabled
        >
            è½‰æ›
        </button>

        <!-- è¼‰å…¥ç‹€æ…‹ -->
        <div id="loadingSection" class="mt-6 text-center hidden">
            <div class="flex items-center justify-center">
                <div class="spinner rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <span class="ml-3 text-gray-600">è½‰æ›ä¸­...</span>
            </div>
        </div>

        <!-- ä¸‹è¼‰å€åŸŸ -->
        <div id="downloadSection" class="mt-6 hidden">
            <div class="text-center p-4 bg-green-50 rounded-lg border border-green-200">
                <div class="flex items-center justify-center mb-2">
                    <svg class="h-6 w-6 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                    <span class="text-green-800 font-medium">è½‰æ›å®Œæˆï¼</span>
                </div>
                <p id="statusText" class="text-green-700 text-sm mb-4"></p>
                <button
                    id="downloadButton"
                    class="w-full py-3 px-6 rounded-lg font-medium transition-colors bg-blue-600 text-white hover:bg-blue-700"
                >
                    ä¸‹è¼‰æª”æ¡ˆ
                </button>
            </div>
        </div>

        <!-- Excelæª”æ¡ˆè™•ç†èªªæ˜ -->
        <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-yellow-800">Excelæª”æ¡ˆè™•ç†èªªæ˜</h3>
                    <div class="mt-2 text-sm text-yellow-700">
                        <p>ç›®å‰ç‰ˆæœ¬åƒ…æ”¯æ´CSVæª”æ¡ˆè½‰æ›ã€‚å¦‚æœæ‚¨æœ‰Excelæª”æ¡ˆï¼Œè«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿè™•ç†ï¼š</p>
                        <ol class="mt-2 list-decimal list-inside space-y-1">
                            <li>é–‹å•ŸExcelæª”æ¡ˆ</li>
                            <li>é»æ“Šã€Œæª”æ¡ˆã€â†’ã€Œå¦å­˜æ–°æª”ã€</li>
                            <li>é¸æ“‡ã€ŒCSV (é€—è™Ÿåˆ†éš”)ã€æ ¼å¼</li>
                            <li>å„²å­˜å¾Œå†ä¸Šå‚³åˆ°æ­¤å·¥å…·</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ç›®æ¨™æ¬„ä½é †åº
        const REQUIRED_COLUMNS = [
            'PARTY_NUMBER',
            'PARTY_NAME', 
            'PERIOD_NAME',
            'NATURAL_ACCOUNT_SEGMENT',
            'NATURAL_ACCOUNT_DESC',
            'GL_DATE',
            'HEADER_DESCRIPTION',
            'TRANSACTION_NUMBER',
            'LINE_DESCRIPTION',
            'ACCOUNTED_DR',
            'ACCOUNTED_CR'
        ];

        // DOM å…ƒç´ 
        const fileInput = document.getElementById('fileInput');
        const fileButton = document.getElementById('fileButton');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const clearButton = document.getElementById('clearButton');
        const convertButton = document.getElementById('convertButton');
        const loadingSection = document.getElementById('loadingSection');
        const downloadSection = document.getElementById('downloadSection');
        const downloadButton = document.getElementById('downloadButton');
        const statusText = document.getElementById('statusText');

        // ç‹€æ…‹è®Šæ•¸
        let selectedFile = null;
        let convertedData = null;

        // è§¸ç™¼å½©å¸¶æ•ˆæœ
        function triggerConfetti() {
            console.log('ğŸŠ é–‹å§‹è§¸ç™¼å½©å¸¶æ•ˆæœ...');
            
            // æª¢æŸ¥ confetti æ˜¯å¦å·²è¼‰å…¥
            if (typeof confetti !== 'undefined') {
                console.log('âœ… confetti å·²è¼‰å…¥ï¼Œé–‹å§‹å½©å¸¶å‹•ç•«');
                try {
                    // ä¸»è¦å½©å¸¶æ•ˆæœ
                    confetti({
                        particleCount: 120,
                        spread: 70,
                        origin: { y: 0.6 }
                    });
                    
                    // å»¶é²è§¸ç™¼ç¬¬äºŒæ¬¡å½©å¸¶
                    setTimeout(() => {
                        confetti({
                            particleCount: 80,
                            spread: 50,
                            origin: { y: 0.8 }
                        });
                    }, 300);
                    
                    console.log('ğŸŠ å½©å¸¶å‹•ç•«å·²è§¸ç™¼');
                } catch (error) {
                    console.error('âŒ å½©å¸¶æ•ˆæœåŸ·è¡Œå¤±æ•—:', error);
                }
            } else {
                console.log('âš ï¸ confetti æœªè¼‰å…¥ï¼Œè«‹æª¢æŸ¥CDN');
            }
        }

        // æª”æ¡ˆé¸æ“‡è™•ç†
        fileButton.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                selectedFile = file;
                fileName.textContent = file.name;
                fileInfo.classList.remove('hidden');
                convertButton.disabled = false;
                convertButton.className = 'w-full py-3 px-6 rounded-lg font-medium transition-colors bg-green-600 text-white hover:bg-green-700';
            }
        });

        // é‡æ–°é¸æ“‡æª”æ¡ˆ
        clearButton.addEventListener('click', () => {
            selectedFile = null;
            convertedData = null;
            fileInput.value = '';
            fileInfo.classList.add('hidden');
            downloadSection.classList.add('hidden');
            convertButton.disabled = true;
            convertButton.className = 'w-full py-3 px-6 rounded-lg font-medium transition-colors bg-gray-300 text-gray-500 cursor-not-allowed';
        });

        // è½‰æ›æª”æ¡ˆ
        convertButton.addEventListener('click', async () => {
            if (!selectedFile) return;

            convertButton.disabled = true;
            convertButton.className = 'w-full py-3 px-6 rounded-lg font-medium transition-colors bg-gray-300 text-gray-500 cursor-not-allowed';
            loadingSection.classList.remove('hidden');
            downloadSection.classList.add('hidden');

            try {
                console.log('é–‹å§‹è™•ç†æª”æ¡ˆ:', selectedFile.name);
                
                // æª¢æŸ¥æª”æ¡ˆé¡å‹
                const fileExtension = selectedFile.name.split('.').pop().toLowerCase();
                console.log('æª”æ¡ˆé¡å‹:', fileExtension);
                
                // å¦‚æœæ˜¯Excelæª”æ¡ˆï¼Œé¡¯ç¤ºè­¦èª
                if (['xlsx', 'xls'].includes(fileExtension)) {
                    throw new Error('ç›®å‰ä¸æ”¯æ´Excelè½‰æª”ï¼Œè«‹å…ˆå°‡Excelæª”æ¡ˆå¦å­˜ç‚ºCSVæ ¼å¼å¾Œå†ä¸Šå‚³');
                }
                
                // åªè™•ç†CSVæª”æ¡ˆ
                if (fileExtension !== 'csv') {
                    throw new Error('è«‹ä¸Šå‚³CSVæª”æ¡ˆ');
                }
                
                console.log('è™•ç†CSVæª”æ¡ˆ...');
                const text = await selectedFile.text();
                console.log('æª”æ¡ˆå¤§å°:', text.length, 'å­—å…ƒ');
                
                // ä½¿ç”¨PapaParseè§£æCSV
                const result = Papa.parse(text, { 
                    header: true, 
                    skipEmptyLines: true,
                    dynamicTyping: false  // ä¸è¦è‡ªå‹•è½‰å‹
                });
                
                const data = result.data;
                console.log('CSVè§£æå®Œæˆï¼Œè³‡æ–™ç­†æ•¸:', data.length);
                
                // è½‰æ›è³‡æ–™æ ¼å¼ - å®Œæ•´ä¿ç•™åŸå§‹å­—ä¸²å…§å®¹
                convertedData = data.map(row => {
                    const newRow = {};
                    REQUIRED_COLUMNS.forEach(column => {
                        const value = row[column];
                        // æ‰€æœ‰æ¬„ä½éƒ½å¼·åˆ¶ä¿æŒåŸå§‹å­—ä¸²æ ¼å¼ï¼Œä¸åšä»»ä½•è½‰æ›
                        if (value !== undefined && value !== null) {
                            let stringValue = String(value);
                            if (column === 'PERIOD_NAME' || column === 'GL_DATE') {
                                newRow[column] = stringValue.trim();
                            } else {
                                newRow[column] = stringValue.trim();
                            }
                        } else {
                            newRow[column] = '';
                        }
                    });
                    return newRow;
                });

                console.log('è½‰æ›å®Œæˆï¼Œè³‡æ–™ç­†æ•¸:', convertedData.length);
                
                if (!convertedData || convertedData.length === 0) {
                    throw new Error('è½‰æ›å¾Œæ²’æœ‰è³‡æ–™ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ ¼å¼æ˜¯å¦æ­£ç¢º');
                }

                // éš±è—è¼‰å…¥ç‹€æ…‹ï¼Œé¡¯ç¤ºä¸‹è¼‰æŒ‰éˆ•
                loadingSection.classList.add('hidden');
                downloadSection.classList.remove('hidden');
                statusText.textContent = `å·²è½‰æ› ${convertedData.length} ç­†è³‡æ–™`;
                
                // ç«‹å³è§¸ç™¼å½©å¸¶æ•ˆæœ
                console.log('ğŸŠ è½‰æ›å®Œæˆï¼Œè§¸ç™¼å½©å¸¶æ•ˆæœ');
                triggerConfetti();
                
                // æ¢å¾©è½‰æ›æŒ‰éˆ•
                convertButton.disabled = false;
                convertButton.className = 'w-full py-3 px-6 rounded-lg font-medium transition-colors bg-green-600 text-white hover:bg-green-700';

            } catch (error) {
                console.error('è½‰æ›å¤±æ•—:', error);
                loadingSection.classList.add('hidden');
                convertButton.disabled = false;
                convertButton.className = 'w-full py-3 px-6 rounded-lg font-medium transition-colors bg-green-600 text-white hover:bg-green-700';
                alert('æª”æ¡ˆè™•ç†å¤±æ•—ï¼š' + error.message);
            }
        });

        // ä¸‹è¼‰æª”æ¡ˆ
        downloadButton.addEventListener('click', () => {
            if (!convertedData) return;

            console.log('é–‹å§‹ç”Ÿæˆä¸‹è¼‰æª”æ¡ˆ...');
            
            // æ‰‹å‹•ç”ŸæˆCSVå…§å®¹ï¼Œä½¿ç”¨æ›´å¼·åŠ›çš„æ ¼å¼ä¿è­·
            let csvContent = REQUIRED_COLUMNS.map(col => `"${col}"`).join(',') + '\n';
            
            convertedData.forEach(row => {
                const values = REQUIRED_COLUMNS.map(column => {
                    let value = row[column] || '';
                    // ç¢ºä¿å€¼è¢«é›™å¼•è™ŸåŒ…ä½ï¼Œä¸¦è™•ç†å…§éƒ¨å¼•è™Ÿ
                    value = String(value).replace(/"/g, '""');
                    return `"${value}"`;
                });
                csvContent += values.join(',') + '\n';
            });

            // æ·»åŠ UTF-8 BOMä»¥ç¢ºä¿Excelæ­£ç¢ºé¡¯ç¤ºä¸­æ–‡
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'converted.csv';
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log('ä¸‹è¼‰å®Œæˆ');
        });
    </script>
</body>
</html>