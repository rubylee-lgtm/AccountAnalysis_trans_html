<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è²¡å‹™ AccountAnalysis è½‰æ›å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        // å‚™ç”¨å½©å¸¶æ•ˆæœï¼Œå¦‚æœCDNè¼‰å…¥å¤±æ•—
        window.fallbackConfetti = function() {
            console.log('ğŸ‰ è½‰æ›å®Œæˆï¼');
            // ç°¡å–®çš„è¦–è¦ºåé¥‹
            document.body.style.background = 'linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1)';
            setTimeout(() => {
                document.body.style.background = '';
            }, 1000);
        };
    </script>
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-2xl">
        <!-- æ¨™é¡Œ -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">è²¡å‹™ AccountAnalysis è½‰æ›å·¥å…·</h1>
            <p class="text-gray-600">ä¸Šå‚³CSVæª”æ¡ˆï¼Œè½‰æ›ç‚ºæ¨™æº–æ ¼å¼</p>
        </div>

        <!-- æª”æ¡ˆé¸æ“‡å€åŸŸ -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                é¸æ“‡æª”æ¡ˆ
            </label>
            <div class="flex items-center space-x-4">
                <input
                    id="fileInput"
                    type="file"
                    accept=".csv"
                    class="hidden"
                />
                <button
                    id="fileButton"
                    class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                >
                    é¸æ“‡æª”æ¡ˆ
                </button>
                <div id="fileInfo" class="flex items-center space-x-2" style="display: none;">
                    <span class="text-sm text-gray-600" id="fileName"></span>
                    <button
                        id="clearButton"
                        class="px-3 py-1 text-xs bg-gray-200 text-gray-600 rounded hover:bg-gray-300 transition-colors"
                    >
                        æ¸…é™¤
                    </button>
                </div>
            </div>
        </div>

        <!-- è½‰æ›æŒ‰éˆ• -->
        <div class="mb-6">
            <button
                id="convertButton"
                disabled
                class="w-full py-3 px-6 rounded-lg font-medium transition-colors bg-gray-300 text-gray-500 cursor-not-allowed"
            >
                è½‰æ›
            </button>
        </div>

        <!-- è¼‰å…¥ç‹€æ…‹ -->
        <div id="loadingSection" class="text-center mb-6" style="display: none;">
            <div class="inline-block w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full spinner"></div>
            <p class="mt-2 text-gray-600">è½‰æ›ä¸­...</p>
        </div>

        <!-- ä¸‹è¼‰æŒ‰éˆ• -->
        <div id="downloadSection" class="text-center" style="display: none;">
            <button
                id="downloadButton"
                class="px-8 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-medium"
            >
                ä¸‹è¼‰æª”æ¡ˆ
            </button>
            <p id="statusText" class="text-sm text-gray-500 mt-2"></p>
        </div>

        <!-- Excelæª”æ¡ˆæç¤º -->
        <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-yellow-800">Excelæª”æ¡ˆè™•ç†èªªæ˜</h3>
                    <div class="mt-2 text-sm text-yellow-700">
                        <p>ç›®å‰ç‰ˆæœ¬åƒ…æ”¯æ´CSVæª”æ¡ˆè½‰æ›ã€‚å¦‚æœæ‚¨æœ‰Excelæª”æ¡ˆï¼Œè«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿè™•ç†ï¼š</p>
                        <ol class="mt-2 list-decimal list-inside space-y-1">
                            <li>é–‹å•ŸExcelæª”æ¡ˆ</li>
                            <li>é»æ“Šã€Œæª”æ¡ˆã€â†’ã€Œå¦å­˜æ–°æª”ã€</li>
                            <li>é¸æ“‡ã€ŒCSV (é€—è™Ÿåˆ†éš”)ã€æ ¼å¼</li>
                            <li>å„²å­˜å¾Œå†ä¸Šå‚³åˆ°æ­¤å·¥å…·</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç›®æ¨™æ¬„ä½èªªæ˜ -->
        <div class="mt-8 p-4 bg-gray-50 rounded-lg">
            <h3 class="font-medium text-gray-800 mb-2">ç›®æ¨™æ¬„ä½é †åºï¼š</h3>
            <div class="text-sm text-gray-600 grid grid-cols-2 gap-1">
                <div class="flex items-center">
                    <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-medium mr-2">1</span>
                    PARTY_NUMBER
                </div>
                <div class="flex items-center">
                    <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-medium mr-2">2</span>
                    PARTY_NAME
                </div>
                <div class="flex items-center">
                    <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-medium mr-2">3</span>
                    PERIOD_NAME
                </div>
                <div class="flex items-center">
                    <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-medium mr-2">4</span>
                    NATURAL_ACCOUNT_SEGMENT
                </div>
                <div class="flex items-center">
                    <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-medium mr-2">5</span>
                    NATURAL_ACCOUNT_DESC
                </div>
                <div class="flex items-center">
                    <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-medium mr-2">6</span>
                    GL_DATE
                </div>
                <div class="flex items-center">
                    <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-medium mr-2">7</span>
                    TRANSACTION_NUMBER
                </div>
                <div class="flex items-center">
                    <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-medium mr-2">8</span>
                    LINE_DESCRIPTION
                </div>
                <div class="flex items-center">
                    <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-medium mr-2">9</span>
                    ACCOUNTED_DR
                </div>
                <div class="flex items-center">
                    <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-medium mr-2">10</span>
                    ACCOUNTED_CR
                </div>
            </div>
        </div>
    </div>

    <script>
        // å®šç¾©éœ€è¦çš„æ¬„ä½é †åº
        const REQUIRED_COLUMNS = [
            'PARTY_NUMBER',
            'PARTY_NAME', 
            'PERIOD_NAME',
            'NATURAL_ACCOUNT_SEGMENT',
            'NATURAL_ACCOUNT_DESC',
            'GL_DATE',
            'TRANSACTION_NUMBER',
            'LINE_DESCRIPTION',
            'ACCOUNTED_DR',
            'ACCOUNTED_CR'
        ];

        // DOM å…ƒç´ 
        const fileInput = document.getElementById('fileInput');
        const fileButton = document.getElementById('fileButton');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const clearButton = document.getElementById('clearButton');
        const convertButton = document.getElementById('convertButton');
        const loadingSection = document.getElementById('loadingSection');
        const downloadSection = document.getElementById('downloadSection');
        const downloadButton = document.getElementById('downloadButton');
        const statusText = document.getElementById('statusText');

        // ç‹€æ…‹è®Šæ•¸
        let selectedFile = null;
        let convertedData = null;

        // è§¸ç™¼å½©å¸¶æ•ˆæœ
        function triggerConfetti() {
            // æª¢æŸ¥ confetti æ˜¯å¦å·²è¼‰å…¥
            if (typeof confetti !== 'undefined') {
                try {
                    confetti({
                        particleCount: 100,
                        spread: 70,
                        origin: { y: 0.6 },
                        colors: ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3']
                    });
                } catch (error) {
                    console.log('å½©å¸¶æ•ˆæœåŸ·è¡Œå¤±æ•—ï¼Œä½¿ç”¨å‚™ç”¨æ–¹æ¡ˆ');
                    window.fallbackConfetti();
                }
            } else {
                console.log('å½©å¸¶æ•ˆæœè¼‰å…¥ä¸­ï¼Œä½¿ç”¨å‚™ç”¨æ–¹æ¡ˆ');
                // å¦‚æœ confetti é‚„æ²’è¼‰å…¥ï¼Œä½¿ç”¨å‚™ç”¨æ–¹æ¡ˆ
                window.fallbackConfetti();
            }
        }

        // æª”æ¡ˆé¸æ“‡è™•ç†
        fileButton.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                selectedFile = file;
                fileName.textContent = `å·²é¸æ“‡ï¼š${file.name}`;
                fileInfo.style.display = 'flex';
                fileButton.textContent = 'é‡æ–°é¸æ“‡æª”æ¡ˆ';
                convertButton.disabled = false;
                convertButton.className = 'w-full py-3 px-6 rounded-lg font-medium transition-colors bg-green-600 text-white hover:bg-green-700';
                downloadSection.style.display = 'none';
            }
        });

        // æ¸…é™¤æª”æ¡ˆ
        clearButton.addEventListener('click', () => {
            selectedFile = null;
            fileInput.value = '';
            fileInfo.style.display = 'none';
            fileButton.textContent = 'é¸æ“‡æª”æ¡ˆ';
            convertButton.disabled = true;
            convertButton.className = 'w-full py-3 px-6 rounded-lg font-medium transition-colors bg-gray-300 text-gray-500 cursor-not-allowed';
            downloadSection.style.display = 'none';
        });

        // è½‰æ›æª”æ¡ˆ
        convertButton.addEventListener('click', async () => {
            if (!selectedFile) return;

            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            convertButton.disabled = true;
            convertButton.className = 'w-full py-3 px-6 rounded-lg font-medium transition-colors bg-gray-300 text-gray-500 cursor-not-allowed';
            loadingSection.style.display = 'block';
            downloadSection.style.display = 'none';

            try {
                console.log('é–‹å§‹è™•ç†æª”æ¡ˆ:', selectedFile.name);
                
                // æª¢æŸ¥æª”æ¡ˆé¡å‹
                const fileExtension = selectedFile.name.split('.').pop().toLowerCase();
                console.log('æª”æ¡ˆé¡å‹:', fileExtension);
                
                // å¦‚æœæ˜¯Excelæª”æ¡ˆï¼Œé¡¯ç¤ºè­¦èª
                if (['xlsx', 'xls'].includes(fileExtension)) {
                    throw new Error('ç›®å‰ä¸æ”¯æ´Excelè½‰æª”ï¼Œè«‹å…ˆå°‡Excelæª”æ¡ˆå¦å­˜ç‚ºCSVæ ¼å¼å¾Œå†ä¸Šå‚³');
                }
                
                // åªè™•ç†CSVæª”æ¡ˆ
                if (fileExtension !== 'csv') {
                    throw new Error('è«‹ä¸Šå‚³CSVæª”æ¡ˆ');
                }
                
                console.log('è™•ç†CSVæª”æ¡ˆ...');
                const text = await selectedFile.text();
                console.log('æª”æ¡ˆå¤§å°:', text.length, 'å­—å…ƒ');
                
                // ä½¿ç”¨PapaParseè§£æCSV
                const result = Papa.parse(text, { 
                    header: true, 
                    skipEmptyLines: true,
                    dynamicTyping: false  // ä¸è¦è‡ªå‹•è½‰å‹
                });
                
                const data = result.data;
                console.log('CSVè§£æå®Œæˆï¼Œè³‡æ–™ç­†æ•¸:', data.length);
                
                // è½‰æ›è³‡æ–™æ ¼å¼ - å®Œæ•´ä¿ç•™åŸå§‹å­—ä¸²å…§å®¹
                convertedData = data.map(row => {
                    const newRow = {};
                    REQUIRED_COLUMNS.forEach(column => {
                        const value = row[column];
                        // æ‰€æœ‰æ¬„ä½éƒ½å¼·åˆ¶ä¿æŒåŸå§‹å­—ä¸²æ ¼å¼ï¼Œä¸åšä»»ä½•è½‰æ›
                        if (value !== undefined && value !== null) {
                            // ç›´æ¥è½‰æ›ç‚ºå­—ä¸²ï¼Œä¿æŒåŸå§‹æ ¼å¼
                            let stringValue = String(value);
                            
                            // ç‰¹åˆ¥è™•ç† PERIOD_NAME å’Œ GL_DATEï¼Œç¢ºä¿å®Œå…¨ä¿æŒåŸå§‹æ ¼å¼
                            if (column === 'PERIOD_NAME' || column === 'GL_DATE') {
                                // å°æ–¼æ—¥æœŸç›¸é—œæ¬„ä½ï¼Œç¢ºä¿å®Œå…¨ä¿æŒåŸå§‹æ ¼å¼
                                newRow[column] = stringValue.trim();
                            } else {
                                // å…¶ä»–æ¬„ä½ä¹Ÿä¿æŒåŸå§‹å­—ä¸²æ ¼å¼
                                newRow[column] = stringValue.trim();
                            }
                        } else {
                            newRow[column] = '';
                        }
                    });
                    return newRow;
                });

                console.log('è½‰æ›å®Œæˆï¼Œè³‡æ–™ç­†æ•¸:', convertedData.length);
                
                // æª¢æŸ¥è½‰æ›çµæœ
                if (!convertedData || convertedData.length === 0) {
                    throw new Error('è½‰æ›å¾Œæ²’æœ‰è³‡æ–™ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ ¼å¼æ˜¯å¦æ­£ç¢º');
                }

                // éš±è—è¼‰å…¥ç‹€æ…‹ï¼Œé¡¯ç¤ºä¸‹è¼‰æŒ‰éˆ•
                loadingSection.style.display = 'none';
                downloadSection.style.display = 'block';
                statusText.textContent = `å·²è½‰æ› ${convertedData.length} ç­†è³‡æ–™`;
                
                // è§¸ç™¼å½©å¸¶æ•ˆæœ
                triggerConfetti();
                
                // æ¢å¾©è½‰æ›æŒ‰éˆ•
                convertButton.disabled = false;
                convertButton.className = 'w-full py-3 px-6 rounded-lg font-medium transition-colors bg-green-600 text-white hover:bg-green-700';

            } catch (error) {
                console.error('è½‰æ›å¤±æ•—:', error);
                loadingSection.style.display = 'none';
                convertButton.disabled = false;
                convertButton.className = 'w-full py-3 px-6 rounded-lg font-medium transition-colors bg-green-600 text-white hover:bg-green-700';
                alert('æª”æ¡ˆè™•ç†å¤±æ•—ï¼š' + error.message);
            }
        });

        // ä¸‹è¼‰æª”æ¡ˆ
        downloadButton.addEventListener('click', () => {
            if (!convertedData) return;

            console.log('é–‹å§‹ç”Ÿæˆä¸‹è¼‰æª”æ¡ˆ...');
            
            // æ‰‹å‹•ç”ŸæˆCSVå…§å®¹ï¼Œä½¿ç”¨æ›´å¼·åŠ›çš„æ ¼å¼ä¿è­·
            let csv = '';
            
            // æ·»åŠ æ¨™é¡Œè¡Œ - ç¢ºä¿æ‰€æœ‰æ¨™é¡Œéƒ½è¢«é›™å¼•è™ŸåŒ…ä½
            const headers = REQUIRED_COLUMNS.map(col => `"${col}"`).join(',');
            csv += headers + '\n';
            
            // æ·»åŠ è³‡æ–™è¡Œ - ä½¿ç”¨æ›´å¼·åŠ›çš„æ ¼å¼ä¿è­·
            convertedData.forEach(row => {
                const values = REQUIRED_COLUMNS.map(column => {
                    const value = row[column] || '';
                    // å¼·åˆ¶è½‰æ›ç‚ºå­—ä¸²ï¼Œç¢ºä¿ä¸æœƒè¢«è½‰æ›ç‚ºæ•¸å­—æˆ–æ—¥æœŸ
                    let stringValue = String(value);
                    
                    // ç‰¹åˆ¥è™•ç†å¯èƒ½è¢«Excelè‡ªå‹•è½‰æ›çš„æ¬„ä½
                    if (column === 'PERIOD_NAME' || column === 'GL_DATE') {
                        // å°æ–¼æ—¥æœŸç›¸é—œæ¬„ä½ï¼Œç¢ºä¿å®Œå…¨ä¿æŒåŸå§‹æ ¼å¼
                        stringValue = stringValue.trim();
                        
                        // å¦‚æœå€¼çœ‹èµ·ä¾†åƒæ—¥æœŸï¼Œä¿æŒåŸå§‹æ ¼å¼
                        if (stringValue.match(/^\d{4}\/\d{1,2}\/\d{1,2}$/) || 
                            stringValue.match(/^\d{1,2}-[A-Za-z]{3}$/) ||
                            stringValue.match(/^[A-Za-z]{3}-\d{2}$/)) {
                            // ä¿æŒåŸå§‹æ ¼å¼ï¼Œä¸åšä»»ä½•ä¿®æ”¹
                        }
                    }
                    
                    // è™•ç†å…§éƒ¨å¼•è™Ÿå’Œç‰¹æ®Šå­—ç¬¦ï¼Œç¢ºä¿CSVæ ¼å¼æ­£ç¢º
                    let escapedValue = stringValue
                        .replace(/"/g, '""')  // è½‰ç¾©é›™å¼•è™Ÿ
                        .replace(/\n/g, ' ')  // æ›¿æ›æ›è¡Œç¬¦
                        .replace(/\r/g, ' ')  // æ›¿æ›å›è»Šç¬¦
                        .replace(/\t/g, ' ')  // æ›¿æ›è£½è¡¨ç¬¦
                    
                    // ç¢ºä¿æ‰€æœ‰å€¼éƒ½è¢«é›™å¼•è™ŸåŒ…ä½ï¼Œé˜²æ­¢Excelè‡ªå‹•è½‰æ›
                    return `"${escapedValue}"`;
                });
                csv += values.join(',') + '\n';
            });
            
            // ç”Ÿæˆæª”æ¡ˆåç¨±
            const filename = 'converted.csv';
            
            // æ·»åŠ BOM (Byte Order Mark) ä¾†ç¢ºä¿UTF-8ç·¨ç¢¼æ­£ç¢ºé¡¯ç¤º
            const BOM = '\uFEFF';
            const csvWithBOM = BOM + csv;
            
            // ä½¿ç”¨æ›´æ˜ç¢ºçš„MIMEé¡å‹ï¼Œé˜²æ­¢Excelè‡ªå‹•è½‰æ›
            const blob = new Blob([csvWithBOM], { 
                type: 'text/csv;charset=utf-8;' 
            });
            
            // å‰µå»ºä¸‹è¼‰é€£çµï¼Œä½¿ç”¨æ›´å¼·åŠ›çš„æ ¼å¼ä¿è­·
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            // æ·»åŠ é¡å¤–çš„å±¬æ€§ä¾†é˜²æ­¢Excelè‡ªå‹•è½‰æ›
            link.setAttribute('data-format', 'csv');
            link.setAttribute('data-encoding', 'utf-8');
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            console.log('æª”æ¡ˆä¸‹è¼‰å®Œæˆ:', filename);
        });
    </script>
</body>
</html>
